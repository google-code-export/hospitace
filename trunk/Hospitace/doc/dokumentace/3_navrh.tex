\chapter{Návrh}

\section{Technologie a služby}
Tato část popisuje jednotlivé technologie a služby potřebné pro implementaci aplikace.

\subsection{Ruby on Rails}
Ruby on Rails \cite{rubyonrails}, zkráceně Rails, je jedno z implementačních omezení, které se nachází přímo v zadání práce. Jedná se o framework primárně určený pro vývoj webových aplikací napojených na relační databázi. Framework je napsán na skriptovacím interpretovaným programovací jazyku Ruby \cite{ruby}. Rails používá návrhový vzor Model-view-controller viz. \ref{mvc}. Mezi základními myšlenkami a filozofií frameworku patří dva principy. Prvním principem je Convention over Configuration viz. \ref{coc} a druhým je Don’t Repeat Yourself viz. \ref{dry}.

\subsubsection{Balíckovací systém RubyGems}
Protože jsou Rails postaveny na jazyku Ruby lze používat balíčkovací systém RubyGems, kde existuje velké množství již existujících řešení, které jsou dostupné jako knihovny\footnote{v RubyGems se knihovna nazývá Gem}. 

\subsection{KOSapi}
\label{kosapi}
KOSapi je webová služba poskytující aplikační rozhraní v podobě RESTful webové služby \ref{rest}. Je určená pro vznik školních aplikací, které potřebují mít přístup k datům souvisejících s výukou. Pro aplikaci používám stabilní verzi API 2. 

Z této služby čerpám hlavně data předmětů a osob v KOSu. Pro připojení ke KOSapi používám již existující knihovnu napsanou v Ruby Tomášem Linhartem a Tomášem Jukínem ve školním projektu VyVy \cite{vyvy_project}.  

\subsection{FELid}
\label{felid}
FELid \cite{felid} je globální autentizační a autorizační systém pro webovské aplikace na síti FEL. Poskytuje jednotný a bezpečný způsob přihlášení uživatelů a přenos jejich údajů do různých aplikací na webu. Zároveň podporuje jednorázové přihlášení (tzv. single sign-on). Znamená to, že se uživatel přihlašuje pouze do první použité aplikaci a u dalších aplikací už nemusí zadávat svoje přihlašovací údaje.

Tuto službu používám pro autentizaci uživatelů do systému. Abych mohl používat v aplikaci FELid je nutné splnit technické požadavky, které jsou napsány na stránkách FELid \cite{felid_pozadavky}.

\subsection{Aplikační server}
\label{apache}
Pro zprovoznění aplikace do reálného provozu jsem použil webový server Apache HTTP server \cite{apache} ve verzi 2. Tento aplikační server jsem zvolil kvůli obecným požadavkům aplikace pro využití FELid a pažadavku aby aplikace byla napsaná v Ruby on Rails. Tato verze webového serveru totiž umožňuje instalaci zásuvných modulů Passenger \cite{passenger} a Shibboleth \cite{shibboleth}. Passenger umožňuje nasazení rails aplikací na aplikačním serveru. Druhý modul Shibboleth zprostředkovává single sign-on autentizaci mezi aplikačním serverem a službou FELid.

\subsection{Databáze}
Ruby on Rails poskytuje možnost připojení k různým databázovým systémům prostřednictvím adaptérů. Díky tomu není aplikace závislá na použitém databázovém systému a díky tomu mohu používat pro vývoj a testování aplikace jednoduchý databázový systém SQLite \cite{sqlite}, který pro tyto účely bohatě postačuje a není potřeba jej složitě konfigurovat. Pro samotné nasazení aplikace do provozu už používám databázový systém MySQL \cite{mysql}.

\section{Architektura}
V této části popisuji použité architektonické vzory a konvence, které dodržuji při návrhu aplikace.

\subsection{MVC}
\label{mvc}
MVC (Model-view-controller) \cite{mvc} je softwarová architektura, která rozděluje datový model aplikace, uživatelské rozhraní a řídicí logiku do tří nezávislých komponent\footnote{models, views a controllers} tak, že modifikace některé z nich má minimální vliv na ostatní. Tento architektonický vzor obsahuje ve svém jádru Ruby on Rails, proto pro implementaci tohoto vzoru vycházím z fungování frameworku.

\subsubsection{Models}
Model reprezentuje informace v aplikaci a pravidla pro práci s nimi. V případě Rails jsou modely primárně využívány pro interakci s příslušnou tabulkou v databázi a pro ukládání pravidel této interakce. Ve většině případů odpovídá jedna tabulka v databázi jednomu modelu aplikaci. Modely obsahují většinu aplikační logiky.

\subsubsection{Views}
Pohledy, neboli views reprezentují uživatelské rozhraní aplikace. V Rails jsou views obvykle HTML soubory s vloženými částmi Ruby kódu, který provádí pouze úkony týkající se prezentace dat. Views mají na starosti poskytování dat webovému prohlížeči nebo jinému nástroji, který zasílá vaší aplikaci požadavky.

\subsubsection{Controllers}
Kontrolory fungují jako zprostředkovatel mezi modely a views. V Rails slouží kontrolory k zpracování požadavků které přichází z webového prohlížeče, získávání dat z modelů a k odesílání těchto dat do views, kde budou zobrazeny.

\subsection{DRY}
\label{dry}
DRY (Don’t repeat yourself) \cite{dry} je princip vývoje softwaru zaměřený na snížení opakování psaní stejného kódu a tím zvyšuje čitelnost a znovupoužitelnost kódu. To znamená, že informace se nacházejí na jednoznačném místě. Pro příklad Ruby on Rails získává definici sloupců pro třídu modelu přímo z databáze.  

\subsection{CoC}
\label{coc}
CoC (Convention over Configuration) \cite{coc} je další princip používaný v Rails pro zlepšení čitelnosti a znovupoužitelnosti kódu. Tento princip znamená, že konvence má přednost před konfigurací a to tak, že Rails předpokládá to, co chcete udělat, místo toho, aby vás nutil specifikovat každou drobnost v konfiguraci. 

\subsection{REST}
\label{rest}
REST (Representational State Transfer) \cite{rest} je architektonický vzor pro webové aplikace. Je založen na HTTP protokolu a hlavní myšlenkou je poskytovat přístup ke zdrojům dat. Všechny zdroje jsou identifikovány přes URI. REST definuje čtyři základní metody pro přístup ke zdrojům. Jsou známé pod označením CRUD\footnote{create, retriece, update a delete}. Tyto metody jsou implementovány pomocí odpovídajících metod HTTP protokolu. Jednotlivé metody rozeberu na příkladech pro zdroj \verb|observations|\footnote{zdroj aplikace pro práci s hospitacemi}.

\paragraph*{Create}
je požadavek, který pomocí metody POST vytvoří nový záznam. Příklad dotazu vytvoří novou hospitaci.

\begin{quote}
\begin{verbatim}
POST /observations
\end{verbatim} 
\end{quote}

\paragraph*{Retrieve}
je požadavek pro přístup ke zdrojům. Funguje stejným způsobem jako běžný požadavek na stránku pomocí GET metody. V prvním příklad vrátí seznam všech hospitace. Druhý příklad vrátí podrobnosti hospitace s id 1.

\begin{quote}
\begin{verbatim}
GET /observations
GET /observations/1
\end{verbatim} 
\end{quote}
 
\paragraph*{Update}
je požadavek, pro upravení konkrétního záznamu přes metodu PUT. 

\begin{quote}
\begin{verbatim}
PUT /observations/1
\end{verbatim} 
\end{quote}

\paragraph*{Delete}
je požadavek, který smaže konkrétní záznam pomocí DELETE metody.

\begin{quote}
\begin{verbatim}
DELETE /observations/1
\end{verbatim} 
\end{quote}

\section{Struktura aplikace}
V této sekci popíšu základní strukturu aplikace. Struktura aplikace je vygenerovaná pomocí generátorů v Ruby on Rails a proto nepopíšu celou strukturu, ale pouze části aplikace, které byli nejdůležitější pro vývoj aplikace. Na obrázku \ref{tree:hospitace} je popsaná strukturu složek a k nim v popisku jejich obsah.

\begin{figure}[h]
	\dirtree{%
		.1 Hospitace/.
		.2 app/.
		.3 assets/ \DTcomment{obsahuje obrázky, JavaScript, CSS}.
		.3 controllers/ \DTcomment{controllers aplikace}.
		.3 helpers/ \DTcomment{pomocné funkce pro vytváření pohledů}.
		.3 inputs/ \DTcomment{speciální vstupní položky pro tvorbu formulářů}.
		.3 mailers/ \DTcomment{třídy které generují a odesílají emaily}.
		.3 models/ \DTcomment{modely aplikace}.
		.3 views/ \DTcomment{šablony aplikace}.		
		.2 lib/\DTcomment{rozšíření a moduly pro aplikaci}.
		.3 email\_templates/ \DTcomment{modul pro generování emailů}.
		.3 tasks/ \DTcomment{obsahuje rake scripty}.
		.3 kosapi/ \DTcomment{knihovna pro připojení ke KOSapi}.
		.3 will\_paginate/ \DTcomment{rozšíření pro modul will\_paginate}.
		.2 public/ \DTcomment{složka, která je přístupná přes web. Obsahuje statické soubory}.
		.2 config/ \DTcomment{konfigurační soubory a směrování}.		
		.2 db/ \DTcomment{schéma databáze a databázové migrace}. 
		.2 test/\DTcomment{testy, testovací data a nástroje pro testování aplikace}.
	}
	\caption{Struktura aplikace}
\label{tree:hospitace}
\end{figure}